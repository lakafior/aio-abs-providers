<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Backbone Config Editor</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 1rem; }
    .provider { border: 1px solid #ccc; padding: 0.5rem; margin-bottom: 0.5rem; }
    label { display: inline-block; width: 150px; }
    input[type="text"], select { width: 200px; }
    .controls { margin-top: 1rem; }
    button { margin-right: 0.5rem; }
    #status { margin-left: 1rem; color: green; }
  </style>
</head>
<body>
  <h1>Backbone Config Editor</h1>
  <p>LAN UI â€” admin endpoints are accessible on the local network.</p>

  <div id="providers"></div>

  <h3>Global</h3>
  <div>
    <label>maxProvidersParallel:</label>
    <input id="global_maxProvidersParallel" type="number" min="1" value="3" />
  </div>
  <div>
    <label>Allow Books:</label>
    <input id="global_allowBooks" type="checkbox" />
  </div>
  <div>
    <label>Allow Audiobooks:</label>
    <input id="global_allowAudiobooks" type="checkbox" />
  </div>
  <div style="margin-top:8px">
    <label>Title / Author balance:</label>
    <input id="global_titleWeight" type="range" min="0" max="100" value="60" />
    <span id="titleWeightLabel">Title 60% / Author 40%</span>
  </div>
  <div style="margin-top:8px">
    <label>Similarity threshold:</label>
    <input id="global_similarityThreshold" type="range" min="0" max="100" value="30" />
    <span id="similarityThresholdLabel">>= 30%</span>
  </div>
  <div style="margin-top:8px">
    <label>Merge best results:</label>
    <input id="global_mergeBestResults" type="checkbox" />
  </div>
  <div style="margin-top:8px">
    <label>Merge field preferences:</label>
    <div id="mergePrefs"></div>
  </div>

  <div class="controls">
    <button id="reload">Reload</button>
    <button id="save">Save</button>
    <span id="status"></span>
  </div>

  <script>
  let currentConfig = null;

    function setStatus(msg, isError = false) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.style.color = isError ? 'red' : 'green';
    }

    function setTokenStatus(/* no-op: token removed */) {}

    async function fetchConfig() {
      setStatus('Loading...');
  const res = await fetch('/admin/config');
      if (!res.ok) {
        setStatus('Failed to load config: ' + res.statusText, true);
        return null;
      }
      const cfg = await res.json();
      setStatus('Loaded');
      return cfg;
    }

    const LANGS = [
      { code: 'pl', label: 'ðŸ‡µðŸ‡± pl' },
      { code: 'en', label: 'ðŸ‡¬ðŸ‡§ en' },
      { code: 'cz', label: 'ðŸ‡¨ðŸ‡¿ cz' },
      { code: 'de', label: 'ðŸ‡©ðŸ‡ª de' },
      { code: 'fr', label: 'ðŸ‡«ðŸ‡· fr' }
    ];

    function makeLanguageSelect(selected, supportedList) {
      const sel = document.createElement('select');
      sel.dataset.key = 'language';
      const options = (supportedList && supportedList.length) ? supportedList.map(code => ({ code, label: code })) : LANGS;
      for (const opt of options) {
        const o = document.createElement('option');
        o.value = opt.code;
        o.textContent = opt.label || opt.code;
        sel.appendChild(o);
      }
      if (selected && !Array.from(sel.options).some(o => o.value === selected)) {
        const o = document.createElement('option'); o.value = selected; o.textContent = selected; sel.appendChild(o);
      }
      sel.value = selected || '';
      return sel;
    }

    function renderProvider(name, cfg, supported = []) {
      const div = document.createElement('div');
      div.className = 'provider';
      div.dataset.name = name;

      const enabled = document.createElement('input'); enabled.type = 'checkbox'; enabled.dataset.key = 'enabled'; enabled.checked = !!cfg.enabled;
      const language = makeLanguageSelect(cfg.language || '', supported);
      const priority = document.createElement('input'); priority.type = 'number'; priority.min = 0; priority.dataset.key = 'priority'; priority.value = (typeof cfg.priority === 'number') ? cfg.priority : 0;
      const concurrency = document.createElement('input'); concurrency.type = 'number'; concurrency.min = 1; concurrency.dataset.key = 'concurrency'; concurrency.value = cfg.concurrency || 1;
  const maxResults = document.createElement('input'); maxResults.type = 'number'; maxResults.min = 0; maxResults.dataset.key = 'maxResults'; maxResults.value = (typeof cfg.maxResults === 'number') ? cfg.maxResults : (cfg.maxResults || 0);
      const timeout = document.createElement('input'); timeout.type = 'number'; timeout.min = 100; timeout.dataset.key = 'timeoutMs'; timeout.value = cfg.timeoutMs || 10000;

      // Extras: provider-specific typed inputs when possible
      let extrasNode = null;
      if (name === 'audioteka') {
        // audioteka: addLinkToDescription boolean
        const chk = document.createElement('input'); chk.type = 'checkbox'; chk.dataset.key = 'extra.addLinkToDescription'; chk.checked = !!(cfg.extra && cfg.extra.addLinkToDescription);
        extrasNode = document.createElement('div'); extrasNode.appendChild(document.createTextNode('Add link to description: ')); extrasNode.appendChild(chk);
      } else if (name === 'storytel') {
        // storytel: preferredRegions as comma-separated
        const regions = document.createElement('input'); regions.type = 'text'; regions.dataset.key = 'extra.preferredRegions'; regions.value = (cfg.extra && cfg.extra.preferredRegions) ? (cfg.extra.preferredRegions.join(',') ) : '';
        extrasNode = document.createElement('div'); extrasNode.appendChild(document.createTextNode('Preferred regions (csv): ')); extrasNode.appendChild(regions);
      } else {
        const ta = document.createElement('textarea'); ta.rows = 3; ta.cols = 40; ta.dataset.key = 'extra'; ta.value = JSON.stringify(cfg.extra || {}, null, 2);
        extrasNode = ta;
      }

      div.innerHTML = `<h4>${name}</h4>`;
      const form = document.createElement('div');
      const row = (labelText, node) => { form.appendChild(document.createTextNode(labelText)); form.appendChild(node); form.appendChild(document.createElement('br')); };
      row('Enabled: ', enabled);
      row('Language: ', language);
      row('Concurrency: ', concurrency);
  row('Max results (0 = unlimited): ', maxResults);
      row('TimeoutMs: ', timeout);
      row('Priority: ', priority);
      row('Extras: ', extrasNode);

      div.appendChild(form);

      return div;
    }

    function renderConfig(cfg, meta = []) {
      currentConfig = cfg;
      const container = document.getElementById('providers');
      container.innerHTML = '';
      for (const [name, p] of Object.entries(cfg.providers || {})) {
        const providerMeta = (meta && meta.find && meta.find(m => m.name === name)) || {};
        const node = renderProvider(name, p, providerMeta.supportedLanguages || []);
        container.appendChild(node);
      }
      renderGlobal(cfg || {});
    }

    async function loadAndRender() {
      const cfg = await fetchConfig();
      let meta = [];
      try {
        const r = await fetch('/admin/providers/meta');
        if (r.ok) meta = await r.json();
      } catch (e) {
        // ignore
      }
      if (cfg) renderConfig(cfg, meta);
    }

    function renderGlobal(cfg) {
      document.getElementById('global_maxProvidersParallel').value = (cfg.global && cfg.global.maxProvidersParallel) || 3;
      document.getElementById('global_allowBooks').checked = (cfg.global && typeof cfg.global.allowBooks !== 'undefined') ? !!cfg.global.allowBooks : true;
      document.getElementById('global_allowAudiobooks').checked = (cfg.global && typeof cfg.global.allowAudiobooks !== 'undefined') ? !!cfg.global.allowAudiobooks : true;
      document.getElementById('global_titleWeight').value = (cfg.global && typeof cfg.global.titleWeight === 'number') ? cfg.global.titleWeight : 60;
      document.getElementById('titleWeightLabel').textContent = `Title ${document.getElementById('global_titleWeight').value}% / Author ${100 - document.getElementById('global_titleWeight').value}%`;
      document.getElementById('global_similarityThreshold').value = (cfg.global && typeof cfg.global.similarityThreshold === 'number') ? cfg.global.similarityThreshold : 30;
      document.getElementById('similarityThresholdLabel').textContent = `>= ${document.getElementById('global_similarityThreshold').value}%`;
    document.getElementById('global_mergeBestResults').checked = !!(cfg.global && cfg.global.mergeBestResults);
      // render merge preferences
      const mergePrefs = cfg.global && cfg.global.mergePreferences ? cfg.global.mergePreferences : {};
  const fields = ['title','subtitle','authors','narrator','description','cover','isbn','asin','duration','publishedYear','rating','url','source','identifiers','publisher','series','seriesIndex','language','genres','tags'];
      const providersList = Object.keys(cfg.providers || {});
      const container = document.getElementById('mergePrefs');
      container.innerHTML = '';
      for (const f of fields) {
        const lbl = document.createElement('div'); lbl.textContent = f + ':';
        const sel = document.createElement('select'); sel.dataset.key = 'mergePref.' + f;
        const optAuto = document.createElement('option'); optAuto.value = ''; optAuto.textContent = '<auto>'; sel.appendChild(optAuto);
        for (const p of providersList) {
          const o = document.createElement('option'); o.value = p; o.textContent = p; sel.appendChild(o);
        }
        sel.value = mergePrefs[f] || '';
        container.appendChild(lbl); container.appendChild(sel);
      }
    }

    document.getElementById('reload').addEventListener('click', loadAndRender);

    document.getElementById('save').addEventListener('click', async () => {
      if (!currentConfig) return setStatus('No config loaded', true);
      const newCfg = { providers: {}, global: {} };
      const container = document.getElementById('providers');
      for (const child of container.children) {
        const name = child.dataset.name;
        const enabled = !!child.querySelector('[data-key="enabled"]').checked;
        const language = child.querySelector('[data-key="language"]').value.trim();
        const concurrency = parseInt(child.querySelector('[data-key="concurrency"]').value, 10) || 1;
        const timeoutMs = parseInt(child.querySelector('[data-key="timeoutMs"]').value, 10) || 10000;
        const priority = parseInt(child.querySelector('[data-key="priority"]').value, 10) || 0;

        // Build extras based on inputs
        let extra = {};
        if (name === 'audioteka') {
          const v = !!child.querySelector('[data-key="extra.addLinkToDescription"]').checked;
          extra.addLinkToDescription = v;
        } else if (name === 'storytel') {
          const v = child.querySelector('[data-key="extra.preferredRegions"]').value.trim();
          extra.preferredRegions = v ? v.split(',').map(s => s.trim()).filter(Boolean) : [];
        } else {
          const ta = child.querySelector('[data-key="extra"]').value || '{}';
          try { extra = JSON.parse(ta); } catch (e) { setStatus('Invalid JSON in extras for ' + name, true); return; }
        }

        const maxResultsVal = parseInt(child.querySelector('[data-key="maxResults"]').value, 10) || 0;
        newCfg.providers[name] = { enabled, priority, language, concurrency, timeoutMs, maxResults: maxResultsVal, extra };
      }
  newCfg.global.maxProvidersParallel = parseInt(document.getElementById('global_maxProvidersParallel').value, 10) || 3;
  newCfg.global.allowBooks = !!document.getElementById('global_allowBooks').checked;
  newCfg.global.allowAudiobooks = !!document.getElementById('global_allowAudiobooks').checked;
  newCfg.global.titleWeight = parseInt(document.getElementById('global_titleWeight').value, 10) || 60;
  newCfg.global.similarityThreshold = parseInt(document.getElementById('global_similarityThreshold').value, 10) || 30;
  newCfg.global.mergeBestResults = !!document.getElementById('global_mergeBestResults').checked;
  // read merge preferences
  const prefFields = ['title','subtitle','authors','narrator','description','cover','isbn','asin','duration','publishedYear','rating','url','source','identifiers','publisher','series','seriesIndex','language','genres','tags'];
  newCfg.global.mergePreferences = {};
  for (const f of prefFields) {
    const sel = document.querySelector('[data-key="mergePref.' + f + '"]');
    if (sel) newCfg.global.mergePreferences[f] = sel.value || null;
  }

        const headers = { 'Content-Type': 'application/json' };
      const res = await fetch('/admin/config', { method: 'PUT', headers, body: JSON.stringify(newCfg) });
      if (!res.ok) {
        let err = null;
        try { err = await res.json(); } catch(e) { /* ignore */ }
        setStatus('Save failed: ' + (err && (err.error || JSON.stringify(err)) || res.statusText), true);
        return;
      }
      const body = await res.json();
      setStatus('Saved');
      // reload config from server response if provided
      if (body && body.config) {
        currentConfig = body.config;
        // fetch provider metadata and re-render so language selects stay provider-specific
          try {
          const rmeta = await fetch('/admin/providers/meta');
          let meta = [];
          if (rmeta.ok) meta = await rmeta.json();
          renderConfig(currentConfig, meta);
        } catch (e) {
          renderConfig(currentConfig);
        }
      } else {
        // fallback: re-fetch
        await loadAndRender();
      }
    });

    // Preview sorting panel
    const previewPanel = document.createElement('div');
    previewPanel.id = 'previewPanel';
    previewPanel.style.marginTop = '1rem';
    previewPanel.innerHTML = '<h3>Provider priority preview</h3>' +
      '<button id="previewBtn">Preview sorting with sample data</button>' +
      '<div id="previewResult" style="margin-top:0.5rem"></div>';
    document.querySelector('.controls').appendChild(previewPanel);

    document.getElementById('previewBtn').addEventListener('click', () => {
      // sample dataset: same similarity audiobooks from different providers
      const samples = [
        { title: 'Sample A', type: 'audiobook', _provider: 'audioteka', similarity: 0.95 },
        { title: 'Sample B', type: 'audiobook', _provider: 'lubimyczytac', similarity: 0.95 },
        { title: 'Sample C', type: 'audiobook', _provider: 'storytel', similarity: 0.95 },
        { title: 'Sample D', type: 'book', _provider: 'audioteka', similarity: 0.95 }
      ];

      // read priorities from UI
      const priorities = {};
      for (const child of document.getElementById('providers').children) {
        const name = child.dataset.name;
        priorities[name] = parseInt(child.querySelector('[data-key="priority"]').value, 10) || 0;
      }

      const sorted = samples.slice().sort((a, b) => {
        if (b.similarity !== a.similarity) return b.similarity - a.similarity;
        const aIsAudio = (a.type === 'audiobook') ? 1 : 0;
        const bIsAudio = (b.type === 'audiobook') ? 1 : 0;
        if (bIsAudio !== aIsAudio) return bIsAudio - aIsAudio;
        const aP = priorities[a._provider] || 0;
        const bP = priorities[b._provider] || 0;
        return bP - aP;
      });

      const out = document.getElementById('previewResult');
      out.innerHTML = '<ol>' + sorted.map(s => `<li>${s.title} â€” ${s.type} â€” provider: ${s._provider} â€” priority: ${priorities[s._provider]||0}</li>`).join('') + '</ol>';
    });

    // initial load
    loadAndRender();
    // live update for titleWeight slider
    const titleSlider = document.getElementById('global_titleWeight');
    if (titleSlider) {
      titleSlider.addEventListener('input', (e) => {
        const v = parseInt(e.target.value, 10) || 0;
        const lbl = document.getElementById('titleWeightLabel');
        if (lbl) lbl.textContent = `Title ${v}% / Author ${100 - v}%`;
      });
    }
    const simSlider = document.getElementById('global_similarityThreshold');
    if (simSlider) {
      simSlider.addEventListener('input', (e) => {
        const v = parseInt(e.target.value, 10) || 0;
        const lbl = document.getElementById('similarityThresholdLabel');
        if (lbl) lbl.textContent = `>= ${v}%`;
      });
    }
  </script>
</body>
</html>
